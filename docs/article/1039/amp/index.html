<!DOCTYPE html>
<html amp lang="en-US">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1">
	<script type="application/ld+json" class="yoast-schema-graph yoast-schema-graph--main">{"@context":"https://schema.org","@graph":[{"@type":"WebSite","@id":"https://uzzz.org/#website","url":"https://uzzz.org/","name":"\u6709\u7ec4\u7ec7\u5728!","potentialAction":{"@type":"SearchAction","target":"https://uzzz.org/?s={search_term_string}","query-input":"required name=search_term_string"}},{"@type":"WebPage","@id":"https://uzzz.org/article/1039/#webpage","url":"https://uzzz.org/article/1039/","inLanguage":"en-US","name":"Tor\u6e90\u7801\u5206\u6790\u4e09 - \u5ba2\u6237\u7aef\u6267\u884c\u6d41\u7a0b\uff08\u521d\u59cb\u5316\uff09 - \u6709\u7ec4\u7ec7\u5728!","isPartOf":{"@id":"https://uzzz.org/#website"},"datePublished":"2013-04-26T06:40:34+00:00","dateModified":"2013-04-26T06:40:34+00:00","author":{"@id":"https://uzzz.org/#/schema/person/29673f1347b0abda5882803c72ee5a3f"}},{"@type":["Person"],"@id":"https://uzzz.org/#/schema/person/29673f1347b0abda5882803c72ee5a3f","name":"fandyvon","sameAs":[]}]}</script>
	<title>Tor源码分析三 - 客户端执行流程（初始化） - 有组织在!</title>
		<link rel="canonical" href="https://uzzz.org/article/1039/">
	<script type="text/javascript" src="https://cdn.ampproject.org/v0.js" async></script>
<style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
	<style amp-custom>
		/* Generic WP styling */

.alignright {
	float: right;
}

.alignleft {
	float: left;
}

.aligncenter {
	display: block;
	text-align: center;
	margin-left: auto;
	margin-right: auto;
}

.amp-wp-enforced-sizes {
	/** Our sizes fallback is 100vw, and we have a padding on the container; the max-width here prevents the element from overflowing. **/
	max-width: 100%;
	margin: 0 auto;
}


/*
 * Prevent cases of amp-img converted from img to appear with stretching by using object-fit to scale.
 * See <https://github.com/ampproject/amphtml/issues/21371#issuecomment-475443219>.
 * Also use object-fit:contain in worst case scenario when we can't figure out dimensions for an image.
 * Additionally, in side of \AMP_Img_Sanitizer::determine_dimensions() it could $amp_img->setAttribute( 'object-fit', 'contain' )
 * so that the following rules wouldn't be needed.
 */
amp-img.amp-wp-enforced-sizes[layout="intrinsic"] > img,
amp-anim.amp-wp-enforced-sizes[layout="intrinsic"] > img {
	object-fit: contain;
}

amp-fit-text blockquote,
amp-fit-text h1,
amp-fit-text h2,
amp-fit-text h3,
amp-fit-text h4,
amp-fit-text h5,
amp-fit-text h6 {
	font-size: inherit;
}

/**
 * Override a style rule in Twenty Sixteen and Twenty Seventeen.
 * It set display:none for audio elements.
 * This selector is the same, though it adds body and uses amp-audio instead of audio.
 */
body amp-audio:not([controls]) {
	display: inline-block;
	height: auto;
}

/*
 * Style the default template messages for submit-success, submit-error, and submitting. These elements are inserted
 * by the form sanitizer when a POST form lacks the action-xhr attribute.
 */
.amp-wp-default-form-message > p {
	margin: 1em 0;
	padding: 0.5em;
}

.amp-wp-default-form-message[submitting] > p,
.amp-wp-default-form-message[submit-success] > p.amp-wp-form-redirecting {
	font-style: italic;
}

.amp-wp-default-form-message[submit-success] > p:not(.amp-wp-form-redirecting) {
	border: solid 1px #008000;
	background-color: #90ee90;
	color: #000;
}

.amp-wp-default-form-message[submit-error] > p {
	border: solid 1px #f00;
	background-color: #ffb6c1;
	color: #000;
}

/* Prevent showing empty success message in the case of an AMP-Redirect-To response header. */
.amp-wp-default-form-message[submit-success] > p:empty {
	display: none;
}

amp-carousel .amp-wp-gallery-caption {
	position: absolute;
	bottom: 0;
	left: 0;
	right: 0;
	text-align: center;
	background-color: rgba(0, 0, 0, 0.5);
	color: #fff;
	padding: 1rem;
}

.wp-block-gallery[data-amp-carousel="true"] {
	display: block;
	flex-wrap: unset;
}

/* Template Styles */

.amp-wp-content,
.amp-wp-title-bar div {
		margin: 0 auto;
	max-width: 840px;
	}

html {
	background: #0a89c0;
}

body {
	background: #fff;
	color: #353535;
	font-family: Georgia, 'Times New Roman', Times, Serif;
	font-weight: 300;
	line-height: 1.75em;
}

p,
ol,
ul,
figure {
	margin: 0 0 1em;
	padding: 0;
}

a,
a:visited {
	color: #0a89c0;
}

a:hover,
a:active,
a:focus {
	color: #353535;
}

/* Quotes */

blockquote {
	color: #353535;
	background: rgba(127,127,127,.125);
	border-left: 2px solid #0a89c0;
	margin: 8px 0 24px 0;
	padding: 16px;
}

blockquote p:last-child {
	margin-bottom: 0;
}

/* UI Fonts */

.amp-wp-meta,
.amp-wp-header div,
.amp-wp-title,
.wp-caption-text,
.amp-wp-tax-category,
.amp-wp-tax-tag,
.amp-wp-comments-link,
.amp-wp-footer p,
.back-to-top {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen-Sans", "Ubuntu", "Cantarell", "Helvetica Neue", sans-serif;
}

/* Header */

.amp-wp-header {
	background-color: #0a89c0;
}

.amp-wp-header div {
	color: #fff;
	font-size: 1em;
	font-weight: 400;
	margin: 0 auto;
	max-width: calc(840px - 32px);
	padding: .875em 16px;
	position: relative;
}

.amp-wp-header a {
	color: #fff;
	text-decoration: none;
}


.amp-wp-header .amp-wp-site-icon {
	/** site icon is 32px **/
	background-color: #fff;
	border: 1px solid #fff;
	border-radius: 50%;
	position: absolute;
	right: 18px;
	top: 10px;
}

/* Article */

.amp-wp-article {
	color: #353535;
	font-weight: 400;
	margin: 1.5em auto;
	max-width: 840px;
	overflow-wrap: break-word;
	word-wrap: break-word;
}

/* Article Header */

.amp-wp-article-header {
	align-items: center;
	align-content: stretch;
	display: flex;
	flex-wrap: wrap;
	justify-content: space-between;
	margin: 1.5em 16px 0;
}

.amp-wp-title {
	color: #353535;
	display: block;
	flex: 1 0 100%;
	font-weight: 900;
	margin: 0 0 .625em;
	width: 100%;
}

/* Article Meta */

.amp-wp-meta {
	color: #696969;
	display: inline-block;
	flex: 2 1 50%;
	font-size: .875em;
	line-height: 1.5em;
	margin: 0 0 1.5em;
	padding: 0;
}

.amp-wp-article-header .amp-wp-meta:last-of-type {
	text-align: right;
}

.amp-wp-article-header .amp-wp-meta:first-of-type {
	text-align: left;
}

.amp-wp-byline amp-img,
.amp-wp-byline .amp-wp-author {
	display: inline-block;
	vertical-align: middle;
}

.amp-wp-byline amp-img {
	border: 1px solid #0a89c0;
	border-radius: 50%;
	position: relative;
	margin-right: 6px;
}

.amp-wp-posted-on {
	text-align: right;
}

/* Featured image */

.amp-wp-article-featured-image {
	margin: 0 0 1em;
}
.amp-wp-article-featured-image amp-img {
	margin: 0 auto;
}
.amp-wp-article-featured-image.wp-caption .wp-caption-text {
	margin: 0 18px;
}

/* Article Content */

.amp-wp-article-content {
	margin: 0 16px;
}

.amp-wp-article-content ul,
.amp-wp-article-content ol {
	margin-left: 1em;
}

.amp-wp-article-content .wp-caption {
	max-width: 100%;
}

.amp-wp-article-content amp-img {
	margin: 0 auto;
}

.amp-wp-article-content amp-img.alignright {
	margin: 0 0 1em 16px;
}

.amp-wp-article-content amp-img.alignleft {
	margin: 0 16px 1em 0;
}

/* Captions */

.wp-caption {
	padding: 0;
}

.wp-caption.alignleft {
	margin-right: 16px;
}

.wp-caption.alignright {
	margin-left: 16px;
}

.wp-caption .wp-caption-text {
	border-bottom: 1px solid #c2c2c2;
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	margin: 0;
	padding: .66em 10px .75em;
}

/* AMP Media */

.alignwide,
.alignfull {
	clear: both;
}

amp-carousel {
	background: #c2c2c2;
	margin: 0 -16px 1.5em;
}
amp-iframe,
amp-youtube,
amp-instagram,
amp-vine {
	background: #c2c2c2;
	margin: 0 -16px 1.5em;
}

.amp-wp-article-content amp-carousel amp-img {
	border: none;
}

amp-carousel > amp-img > img {
	object-fit: contain;
}

.amp-wp-iframe-placeholder {
	background: #c2c2c2 url( https://uzzz.org/wp-content/plugins/amp/assets/images/placeholder-icon.png ) no-repeat center 40%;
	background-size: 48px 48px;
	min-height: 48px;
}

/* Article Footer Meta */

.amp-wp-article-footer .amp-wp-meta {
	display: block;
}

.amp-wp-tax-category,
.amp-wp-tax-tag {
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	margin: 1.5em 16px;
}

.amp-wp-comments-link {
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	text-align: center;
	margin: 2.25em 0 1.5em;
}

.amp-wp-comments-link a {
	border-style: solid;
	border-color: #c2c2c2;
	border-width: 1px 1px 2px;
	border-radius: 4px;
	background-color: transparent;
	color: #0a89c0;
	cursor: pointer;
	display: block;
	font-size: 14px;
	font-weight: 600;
	line-height: 18px;
	margin: 0 auto;
	max-width: 200px;
	padding: 11px 16px;
	text-decoration: none;
	width: 50%;
	-webkit-transition: background-color 0.2s ease;
			transition: background-color 0.2s ease;
}

/* AMP Footer */

.amp-wp-footer {
	border-top: 1px solid #c2c2c2;
	margin: calc(1.5em - 1px) 0 0;
}

.amp-wp-footer div {
	margin: 0 auto;
	max-width: calc(840px - 32px);
	padding: 1.25em 16px 1.25em;
	position: relative;
}

.amp-wp-footer h2 {
	font-size: 1em;
	line-height: 1.375em;
	margin: 0 0 .5em;
}

.amp-wp-footer p {
	color: #696969;
	font-size: .8em;
	line-height: 1.5em;
	margin: 0 85px 0 0;
}

.amp-wp-footer a {
	text-decoration: none;
}

.back-to-top {
	bottom: 1.275em;
	font-size: .8em;
	font-weight: 600;
	line-height: 2em;
	position: absolute;
	right: 16px;
}
		/* Inline stylesheets */
.htmledit_views em{font-style:italic}.htmledit_views{font-family:-apple-system,SF UI Text,Arial,PingFang SC,Hiragino Sans GB,Microsoft YaHei,WenQuanYi Micro Hei,sans-serif,SimHei,SimSun}.htmledit_views p{font-size:16px;color:#4d4d4d;font-weight:400;line-height:26px;margin:0 0 16px;overflow-x:auto}.htmledit_views strong{font-weight:700}.htmledit_views *{box-sizing:border-box}.htmledit_views h2,.htmledit_views h3{color:#4f4f4f;margin:8px 0 16px;font-weight:700}.htmledit_views h2{font-size:24px;line-height:32px}.htmledit_views h3{font-size:22px;line-height:30px}	</style>
</head>

<body class="">

<header id="top" class="amp-wp-header">
	<div>
		<a href="https://uzzz.org/">
										<amp-img src="https://uzzz.org/wp-content/uploads/2019/10/cropped-icon-32x32.png" width="32" height="32" class="amp-wp-site-icon"></amp-img>
						<span class="amp-site-title">
				有组织在!			</span>
		</a>

					</div>
</header>

<article class="amp-wp-article">
	<header class="amp-wp-article-header">
		<h1 class="amp-wp-title">Tor源码分析三 — 客户端执行流程（初始化）</h1>
			<div class="amp-wp-meta amp-wp-byline">
					<amp-img src="https://secure.gravatar.com/avatar/e786821a74ef0467825a7d60183307bc?s=24&d=mm&r=g" alt="fandyvon" width="24" height="24" layout="fixed"></amp-img>
				<span class="amp-wp-author author vcard">fandyvon</span>
	</div>
<div class="amp-wp-meta amp-wp-posted-on">
	<time datetime="2013-04-26T14:40:34+00:00">
		7 years ago	</time>
</div>
	</header>

	
	<div class="amp-wp-article-content">
		<div id="article_content" class="article_content clearfix">
 
 
<div class="htmledit_views" id="content_views">
<p>　　Tor系统中，主机的身份包括有这几种：Client，Bridge Server，Relay Server，Directory Server。</p>
<p>　　当然，有的时候一台主机是可以身兼数个身份，提供不同的服务或获取服务。</p>
<p>　　我们从最简单的客户端配置的Tor来进行分析，事先了解整个Tor系统的执行规程，之后再具体分析其他身份时候的不同操作，从而加快了解系统的速度。此处要说明的是，由于笔者对Windows的编程不甚了解，暂时就去除源码中所有为了让Tor系统具有夸平台性的Windows代码部分。</p>
<p></p>
<h2>1. Tor系统的入口函数</h2>
<p>　　大部分源程序的入口函数是main。Tor系统为了实现更加简便的单元测试，将main函数设为调用tor_main函数，后者是整个Tor系统的执行主函数。上述关系可以在Tor_main.c文件中看到，该文件中只是用很少的几行描述了main与tor_main之间的关系。</p>
<p></p>
<h2>2. Tor系统初始化</h2>
<p>　　系统初始化包括四个函数：</p>
<p>　　1）update_approx_time(time(NULL))</p>
<p>　　　　记录当前时间的估值，存于<em>cached_approx_time</em>，一般每秒钟被系统其它部分调用一次。在系统开始运行时，最先执行。</p>
<p>　　2）tor_threads_init()</p>
<p>　　　　根据Tor系统是否被允许是多线程运行而执行不同的操作。</p>
<p>　　　　若不允许多线程运行，则不做操作；</p>
<p>　　　　若允许，记录<em>main_thread_id</em>，并根据系统的平台，设置<em>thread_initialized</em>标签以及对多线程参数进行初始化。</p>
<p>　　3）init_logging()</p>
<p>　　　　初始化系统日志信息列表。</p>
<p>　　　　初始化对log进行操作的互斥量<em>log_mutex</em>，设置<em>log_mutex_initialized</em>标签。在系统刚刚启动时，会新建log日志消息链表<em>pending_cb_message</em>。</p>
<p>　　　　注：smartlist是Tor系统实现的一个链表系统，可以执行基本链表操作等。</p>
<p>　　4）tor_init()</p>
<p>　　　　系统最主要的初始化函数。</p>
<p>　　　　i）初始化系统最重要的几个全局变量：</p>
<p><em>　　　　　　　time_of_process_start</em>，进程开始真正运行的时间；</p>
<p><em>　　　　　　　connection_array</em>，系统所有连接链表，连接包括DIR, AP, OR, EXIT等类型的连接；</p>
<p><em>　　　　　　　closeable_connection_lst</em>，系统所有要关闭的连接链表；</p>
<p><em>　　　　　　　active_linked_connection_lst</em>，<em></em>系统所有活动的linked连接链表，linked连接包括DIR, AP等类型的连接。</p>
<p>　　　　ii）输出调试信息和设置应用程序名<em>appname</em>；</p>
<p>　　　　iii）初始化三个子功能件：</p>
<p><em>　　　　　　　rep_hist_init()</em>，reputation history初始化，包括摘要映射表<em>history_map</em>，带宽数组<em>bw_array</em>，预测端口<em>predicted_ports_list</em>等初始化；</p>
<p><em>　　　　　　　rend_cache_init()</em>，初始化服务描述符缓存<em>rend_cache</em>，<em>rend_cache_v2_dir</em>；</p>
<p><em>　　　　　　　addressmap_init()</em>，初始化地址映射<em>addressmap</em>，<em>virtaddress_reversemap</em>；</p>
<p>　　　　iv）通过tor配置文件及命令行参数初始化tor系统，生成全局选项变量<em>global_options</em>；options_init_from_torrc()（非常重要，读者要自行详细分析）</p>
<p>　　　　　　　开启系统监听的端口；生成Lock与State文件；解析固化在系统代码内的10个目录服务器地址；解析GeoIp文件；执行其他相关操作。</p>
<p>　　　　v）初始化OpenSSL：crypto_global_init()（略）</p>
<p></p>
<h2>3. option_init_from_torrc()函数解析</h2>
<p>　　该函数指定了Tor运行的执行操作：CMD_RUN_TOR，CMD_LIST_FINGERPRINT，CMD_VERIFY_CONFIG，CMD_HASH_PASSWORD。</p>
<p>　　其中，CMD_RUN_TOR是Tor系统真正的执行命令。当输入的参数argv不存在上述后面三个命令之时，系统默认执行Tor主线命令，启动Tor系统。</p>
<p>　　而在系统启动之前，还需要进行默认配置文件，输入配置文件以及命令参数的综合解析，所以该函数中出现以下执行代码：</p>
<p>　　　　1）cf_default = load_torrc_from_disk(argc, argv, 1)；读取默认配置文件中的配置参数，输出为整个字符串。</p>
<p>　　　　2）cf = load_torrc_from_disk(argc, argv, 0)；读取命令行输入的配置文件的配置参数，输出为整个字符串。</p>
<p>　　　　3）options_init_from_string(cf_default, cf, command, command_arg, &errmsg)；利用输入的所有配置参数初步启动系统。</p>
<p>　　　　　　cf = config；cf_default = config default；</p>
<p>　　　　　　command = 系统主命令；command_arg = 系统主命令参数，其实就是一般的命令行输入参数；errmsg为错误输出消息。</p>
<p>　　该函数的重点，在于调用了options_init_from_string()函数，从而往下调用到set_options()函数，而后又深层调用到了options_act_reversible()和options_act()。上述深层调用到的函数，会很细节地初始化Tor系统的大多部分，此处就不再赘述。另外关于配置，不得不提的是：默认配置，输入配置文件以及命令行的配置，三个配置之间的选择规则，是三者的优先级逐级递增。也就是说，输入配置文件的配置会先覆盖默认配置文件的配置，命令行的配置会再次覆盖输入配置文件的配置。实际上这个部分还有更复杂的规则，具体细则，可以参看Tor Manual的详细说明。此处就黏贴如下，不再翻译：</p>
<h3><strong>　　By default, an option on the command line overrides an option found in the configuration file, and an option in a configuration file overrides one in the defaults file.</strong></h3>
<h3><strong>　　This rule is simple for options that take a single value, but it can become complicated for options that are allowed to occur more than once: if you specify four SOCKSPorts in your configuration file, and one more SOCKSPort on the command line, the option on the command line will replace all of the SOCKSPorts in the configuration file. If this isn’t what you want, prefix the option name with a plus sign, and it will be appended to the previous set of options instead.</strong></h3>
<h3><strong>　　Alternatively, you might want to remove every instance of an option in the configuration file, and not replace it at all: you might want to say on the command line that you want no SOCKSPorts at all. To do that, prefix the option name with a forward slash.</strong></h3>
<p></p>
</div>
</div>
	</div>

	<footer class="amp-wp-article-footer">
			<div class="amp-wp-meta amp-wp-tax-category">
		Categories: <a href="https://uzzz.org/category/deeplearning/" rel="category tag">DeepLearning</a>	</div>

	</footer>
</article>

<footer class="amp-wp-footer">
	<div>
		<h2>有组织在!</h2>
		<a href="#top" class="back-to-top">Back to top</a>
	</div>
</footer>



</body>
</html>
