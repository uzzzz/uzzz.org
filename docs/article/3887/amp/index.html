<!DOCTYPE html>
<html amp lang="en-US">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1">
	<script type="application/ld+json" class="yoast-schema-graph yoast-schema-graph--main">{"@context":"https://schema.org","@graph":[{"@type":"WebSite","@id":"https://uzzz.org/#website","url":"https://uzzz.org/","name":"\u6709\u7ec4\u7ec7\u5728!","potentialAction":{"@type":"SearchAction","target":"https://uzzz.org/?s={search_term_string}","query-input":"required name=search_term_string"}},{"@type":"ImageObject","@id":"https://uzzz.org/article/3887/#primaryimage","url":"https://profile.csdnimg.cn/2/5/D/3_gx11251143"},{"@type":"WebPage","@id":"https://uzzz.org/article/3887/#webpage","url":"https://uzzz.org/article/3887/","inLanguage":"en-US","name":"Http tunnel\u6280\u672f\u4ecb\u7ecd - \u6709\u7ec4\u7ec7\u5728!","isPartOf":{"@id":"https://uzzz.org/#website"},"primaryImageOfPage":{"@id":"https://uzzz.org/article/3887/#primaryimage"},"datePublished":"2020-02-26T07:49:10+00:00","dateModified":"2020-02-26T07:49:10+00:00","author":{"@id":"https://uzzz.org/#/schema/person/29673f1347b0abda5882803c72ee5a3f"}},{"@type":["Person"],"@id":"https://uzzz.org/#/schema/person/29673f1347b0abda5882803c72ee5a3f","name":"fandyvon","sameAs":[]}]}</script>
	<title>Http tunnel技术介绍 - 有组织在!</title>
		<link rel="canonical" href="https://uzzz.org/article/3887/">
	<script type="text/javascript" src="https://cdn.ampproject.org/v0.js" async></script>
<style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
	<style amp-custom>
		/* Generic WP styling */

.alignright {
	float: right;
}

.alignleft {
	float: left;
}

.aligncenter {
	display: block;
	text-align: center;
	margin-left: auto;
	margin-right: auto;
}

.amp-wp-enforced-sizes {
	/** Our sizes fallback is 100vw, and we have a padding on the container; the max-width here prevents the element from overflowing. **/
	max-width: 100%;
	margin: 0 auto;
}


/*
 * Prevent cases of amp-img converted from img to appear with stretching by using object-fit to scale.
 * See <https://github.com/ampproject/amphtml/issues/21371#issuecomment-475443219>.
 * Also use object-fit:contain in worst case scenario when we can't figure out dimensions for an image.
 * Additionally, in side of \AMP_Img_Sanitizer::determine_dimensions() it could $amp_img->setAttribute( 'object-fit', 'contain' )
 * so that the following rules wouldn't be needed.
 */
amp-img.amp-wp-enforced-sizes[layout="intrinsic"] > img,
amp-anim.amp-wp-enforced-sizes[layout="intrinsic"] > img {
	object-fit: contain;
}

amp-fit-text blockquote,
amp-fit-text h1,
amp-fit-text h2,
amp-fit-text h3,
amp-fit-text h4,
amp-fit-text h5,
amp-fit-text h6 {
	font-size: inherit;
}

/**
 * Override a style rule in Twenty Sixteen and Twenty Seventeen.
 * It set display:none for audio elements.
 * This selector is the same, though it adds body and uses amp-audio instead of audio.
 */
body amp-audio:not([controls]) {
	display: inline-block;
	height: auto;
}

/*
 * Style the default template messages for submit-success, submit-error, and submitting. These elements are inserted
 * by the form sanitizer when a POST form lacks the action-xhr attribute.
 */
.amp-wp-default-form-message > p {
	margin: 1em 0;
	padding: 0.5em;
}

.amp-wp-default-form-message[submitting] > p,
.amp-wp-default-form-message[submit-success] > p.amp-wp-form-redirecting {
	font-style: italic;
}

.amp-wp-default-form-message[submit-success] > p:not(.amp-wp-form-redirecting) {
	border: solid 1px #008000;
	background-color: #90ee90;
	color: #000;
}

.amp-wp-default-form-message[submit-error] > p {
	border: solid 1px #f00;
	background-color: #ffb6c1;
	color: #000;
}

/* Prevent showing empty success message in the case of an AMP-Redirect-To response header. */
.amp-wp-default-form-message[submit-success] > p:empty {
	display: none;
}

amp-carousel .amp-wp-gallery-caption {
	position: absolute;
	bottom: 0;
	left: 0;
	right: 0;
	text-align: center;
	background-color: rgba(0, 0, 0, 0.5);
	color: #fff;
	padding: 1rem;
}

.wp-block-gallery[data-amp-carousel="true"] {
	display: block;
	flex-wrap: unset;
}

/* Template Styles */

.amp-wp-content,
.amp-wp-title-bar div {
		margin: 0 auto;
	max-width: 840px;
	}

html {
	background: #0a89c0;
}

body {
	background: #fff;
	color: #353535;
	font-family: Georgia, 'Times New Roman', Times, Serif;
	font-weight: 300;
	line-height: 1.75em;
}

p,
ol,
ul,
figure {
	margin: 0 0 1em;
	padding: 0;
}

a,
a:visited {
	color: #0a89c0;
}

a:hover,
a:active,
a:focus {
	color: #353535;
}

/* Quotes */

blockquote {
	color: #353535;
	background: rgba(127,127,127,.125);
	border-left: 2px solid #0a89c0;
	margin: 8px 0 24px 0;
	padding: 16px;
}

blockquote p:last-child {
	margin-bottom: 0;
}

/* UI Fonts */

.amp-wp-meta,
.amp-wp-header div,
.amp-wp-title,
.wp-caption-text,
.amp-wp-tax-category,
.amp-wp-tax-tag,
.amp-wp-comments-link,
.amp-wp-footer p,
.back-to-top {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen-Sans", "Ubuntu", "Cantarell", "Helvetica Neue", sans-serif;
}

/* Header */

.amp-wp-header {
	background-color: #0a89c0;
}

.amp-wp-header div {
	color: #fff;
	font-size: 1em;
	font-weight: 400;
	margin: 0 auto;
	max-width: calc(840px - 32px);
	padding: .875em 16px;
	position: relative;
}

.amp-wp-header a {
	color: #fff;
	text-decoration: none;
}


.amp-wp-header .amp-wp-site-icon {
	/** site icon is 32px **/
	background-color: #fff;
	border: 1px solid #fff;
	border-radius: 50%;
	position: absolute;
	right: 18px;
	top: 10px;
}

/* Article */

.amp-wp-article {
	color: #353535;
	font-weight: 400;
	margin: 1.5em auto;
	max-width: 840px;
	overflow-wrap: break-word;
	word-wrap: break-word;
}

/* Article Header */

.amp-wp-article-header {
	align-items: center;
	align-content: stretch;
	display: flex;
	flex-wrap: wrap;
	justify-content: space-between;
	margin: 1.5em 16px 0;
}

.amp-wp-title {
	color: #353535;
	display: block;
	flex: 1 0 100%;
	font-weight: 900;
	margin: 0 0 .625em;
	width: 100%;
}

/* Article Meta */

.amp-wp-meta {
	color: #696969;
	display: inline-block;
	flex: 2 1 50%;
	font-size: .875em;
	line-height: 1.5em;
	margin: 0 0 1.5em;
	padding: 0;
}

.amp-wp-article-header .amp-wp-meta:last-of-type {
	text-align: right;
}

.amp-wp-article-header .amp-wp-meta:first-of-type {
	text-align: left;
}

.amp-wp-byline amp-img,
.amp-wp-byline .amp-wp-author {
	display: inline-block;
	vertical-align: middle;
}

.amp-wp-byline amp-img {
	border: 1px solid #0a89c0;
	border-radius: 50%;
	position: relative;
	margin-right: 6px;
}

.amp-wp-posted-on {
	text-align: right;
}

/* Featured image */

.amp-wp-article-featured-image {
	margin: 0 0 1em;
}
.amp-wp-article-featured-image amp-img {
	margin: 0 auto;
}
.amp-wp-article-featured-image.wp-caption .wp-caption-text {
	margin: 0 18px;
}

/* Article Content */

.amp-wp-article-content {
	margin: 0 16px;
}

.amp-wp-article-content ul,
.amp-wp-article-content ol {
	margin-left: 1em;
}

.amp-wp-article-content .wp-caption {
	max-width: 100%;
}

.amp-wp-article-content amp-img {
	margin: 0 auto;
}

.amp-wp-article-content amp-img.alignright {
	margin: 0 0 1em 16px;
}

.amp-wp-article-content amp-img.alignleft {
	margin: 0 16px 1em 0;
}

/* Captions */

.wp-caption {
	padding: 0;
}

.wp-caption.alignleft {
	margin-right: 16px;
}

.wp-caption.alignright {
	margin-left: 16px;
}

.wp-caption .wp-caption-text {
	border-bottom: 1px solid #c2c2c2;
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	margin: 0;
	padding: .66em 10px .75em;
}

/* AMP Media */

.alignwide,
.alignfull {
	clear: both;
}

amp-carousel {
	background: #c2c2c2;
	margin: 0 -16px 1.5em;
}
amp-iframe,
amp-youtube,
amp-instagram,
amp-vine {
	background: #c2c2c2;
	margin: 0 -16px 1.5em;
}

.amp-wp-article-content amp-carousel amp-img {
	border: none;
}

amp-carousel > amp-img > img {
	object-fit: contain;
}

.amp-wp-iframe-placeholder {
	background: #c2c2c2 url( https://uzzz.org/wp-content/plugins/amp/assets/images/placeholder-icon.png ) no-repeat center 40%;
	background-size: 48px 48px;
	min-height: 48px;
}

/* Article Footer Meta */

.amp-wp-article-footer .amp-wp-meta {
	display: block;
}

.amp-wp-tax-category,
.amp-wp-tax-tag {
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	margin: 1.5em 16px;
}

.amp-wp-comments-link {
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	text-align: center;
	margin: 2.25em 0 1.5em;
}

.amp-wp-comments-link a {
	border-style: solid;
	border-color: #c2c2c2;
	border-width: 1px 1px 2px;
	border-radius: 4px;
	background-color: transparent;
	color: #0a89c0;
	cursor: pointer;
	display: block;
	font-size: 14px;
	font-weight: 600;
	line-height: 18px;
	margin: 0 auto;
	max-width: 200px;
	padding: 11px 16px;
	text-decoration: none;
	width: 50%;
	-webkit-transition: background-color 0.2s ease;
			transition: background-color 0.2s ease;
}

/* AMP Footer */

.amp-wp-footer {
	border-top: 1px solid #c2c2c2;
	margin: calc(1.5em - 1px) 0 0;
}

.amp-wp-footer div {
	margin: 0 auto;
	max-width: calc(840px - 32px);
	padding: 1.25em 16px 1.25em;
	position: relative;
}

.amp-wp-footer h2 {
	font-size: 1em;
	line-height: 1.375em;
	margin: 0 0 .5em;
}

.amp-wp-footer p {
	color: #696969;
	font-size: .8em;
	line-height: 1.5em;
	margin: 0 85px 0 0;
}

.amp-wp-footer a {
	text-decoration: none;
}

.back-to-top {
	bottom: 1.275em;
	font-size: .8em;
	font-weight: 600;
	line-height: 2em;
	position: absolute;
	right: 16px;
}
		/* Inline stylesheets */
.htmledit_views{font-family:-apple-system,SF UI Text,Arial,PingFang SC,Hiragino Sans GB,Microsoft YaHei,WenQuanYi Micro Hei,sans-serif,SimHei,SimSun}.htmledit_views a>amp-img{padding:1px;margin:1px;border:none;outline:#0782c1 solid 1px}.htmledit_views p{font-size:16px;color:#4d4d4d;font-weight:400;line-height:26px;margin:0 0 16px;overflow-x:auto}.htmledit_views amp-img{max-width:100%;height:auto}.htmledit_views strong,.htmledit_views strong span{font-weight:700}.htmledit_views *{box-sizing:border-box}.htmledit_views ul{margin:0 0 24px;padding:0;font-size:16px}.htmledit_views ul li{list-style-type:disc;margin:8px 0 0 32px}.htmledit_views a{color:#4ea1db;text-decoration:none}.htmledit_views a:focus,.htmledit_views a:hover{color:#ca0c16}.htmledit_views a:visited{color:#6795b5}:root:not(#_):not(#_):not(#_):not(#_):not(#_) .amp-wp-9456def{color:#000}:root:not(#_):not(#_):not(#_):not(#_):not(#_) .amp-wp-36301fc{color:#2f2f2f}	</style>
</head>

<body class="">

<header id="top" class="amp-wp-header">
	<div>
		<a href="https://uzzz.org/">
										<amp-img src="https://uzzz.org/wp-content/uploads/2019/10/cropped-icon-32x32.png" width="32" height="32" class="amp-wp-site-icon"></amp-img>
						<span class="amp-site-title">
				有组织在!			</span>
		</a>

					</div>
</header>

<article class="amp-wp-article">
	<header class="amp-wp-article-header">
		<h1 class="amp-wp-title">Http tunnel技术介绍</h1>
			<div class="amp-wp-meta amp-wp-byline">
					<amp-img src="https://secure.gravatar.com/avatar/e786821a74ef0467825a7d60183307bc?s=24&d=mm&r=g" alt="fandyvon" width="24" height="24" layout="fixed"></amp-img>
				<span class="amp-wp-author author vcard">fandyvon</span>
	</div>
<div class="amp-wp-meta amp-wp-posted-on">
	<time datetime="2020-02-26T15:49:10+00:00">
		1 month ago	</time>
</div>
	</header>

	
	<div class="amp-wp-article-content">
		<p><br>
<br>
<br>
 </p>
<div id="article_content" class="article_content clearfix">
 
 
<div class="htmledit_views" id="content_views">
<p><span class="amp-wp-36301fc">什么是http暗藏通道？什么是局域网安全，系统管理员怎样才能保障局域网的安全？这是一个不断变化的安全概念，很长的一个时期以来，在局域网与外界互联处放置一个防火墙，严格控制开放的端口，就能在很大程度上掌握安全的主动权，方便的控制网内外用户所能使用的服务。比如，在防火墙上仅仅开放80，53两个端口，那么无论是内部还是外面的恶意人士都将无法使用一些已经证明比较危险的服务。</span></p>
<p><span class="amp-wp-36301fc">　　但要注意一点，防火墙在某种意义上是很愚蠢的，管理员对防火墙的过分依赖以及从而产生的懈怠情绪将不可避免的形成安全上的重大隐患，作为一个证明，”通道”技术就是一个很好的例子，这也是本文要讨论的。</span></p>
<p><span class="amp-wp-36301fc">　　那么什么是通道呢?这里所谓的通道，是指一种绕过防火墙端口屏蔽的通讯方式。防火墙两端的数据包封装在防火墙所允许通过的数据包类型或是端口上，然后穿过防火墙与对端通讯，当封装的数据包到达目的地时，再将数据包还原，并将还原后的数据包交送到相应的服务上。举例如下:</span></p>
<p><span class="amp-wp-36301fc">　　A 主机系统在防火墙之后，受防火墙保护，防火墙配置的访问控制原则是只允许80端口的数据进出，B主机系统在防火墙之外，是开放的。现在假设需要从A系统 Telnet到B系统上去，怎么办?使用正常的telnet肯定是不可能了，但我们知道可用的只有80端口，那么这个时候使用Httptunnel通道，就是一个好的办法，思路如下:</span></p>
<p><span class="amp-wp-36301fc">　　在A机器上起一个tunnel的client端，让它侦听本机的一个不被使用的任意指定端口，如 1234，同时将来自1234端口上的数据指引到远端(B机)的80端口上(注意，是80端口，防火墙允许通过)，然后在B机上起一个 server，同样挂接在80端口上，同时指引80端口的来自client的转发到本机的telnet服务端口23，这样就ok了。现在在A机上 telnet本机端口1234，根据刚才的设置数据包会被转发到目标端口为80的B机，因为防火墙允许通过80端口的数据，因此数据包畅通的穿过防火墙，到达B机。此时B机在80端口侦听的进程收到来自A的数据包，会将数据包还原，再交还给telnet进程。当数据包需要由B到A返回时，将由80端口再回送，同样可以顺利的通过防火墙。</span></p>
<p><span class="amp-wp-36301fc">　　实际上tunnel概念已经产生很久了，而且很有可能读者使用过类似的技术，比如下面的网址 <a href="http://www.http-tunnel.com/" rel="nofollow"><span class="amp-wp-9456def">http://www.http-tunnel.com</span></a>。它是一个专业提供tunnel服务的公司，通过他们的在线tunnel server,局域网内的用户可以使用被防火墙所屏蔽的ICQ，E-MAIL，pcanywhere， AIM，MSN， Yahoo，Morpheus，Napster等等诸多软件。我们看到，这里有ICQ,Napster等软件，相信我们的读者很多都使用过走proxy的 ICQ,OICQ等等，其实他们的原理是差不多的。</span></p>
<p> 　　<strong>什么是Httptunnel</strong></p>
<p> 　　作为一个实际的例子，我们下面来介绍一个在”非公开领域”使用的的通道软件，httptunnel。在httptunnel主页上有这么一端话，</p>
<p> 　　httptunnel creates a bidirectional virtual data connection tunnelled in HTTP requests. The HTTP requests can be sent via an HTTP proxy if so desired. This can be useful for users behind restrictive firewalls. If WWW access is allowed through a HTTP proxy, it’s possible to use httptunnel and, say, telnet or PPP to connect to a computer outside the firewall.</p>
<p> 　　从这段说明中我们可以看出来它就是我们今天说要介绍的tunnel技术的一个证明，我们下面大致介绍一下它的使用。</p>
<p> 　　httptunnel目前比较稳定的版本是3.0.5, 支持各种常见的unix系统，包括window平台。可以从相关站点下载，它的安装是比较简单的，照INSTALL文件做就可以了，这里不介绍。</p>
<p> 　　整个软件安装完毕后，我们会得到两个关键文件，htc和hts,其中htc是客户端(c)，而hts是server(s)端，我们来看看具体怎么使用的。</p>
<p> 　　假设有A(域名client.yiming.com)机，B(域名server.yiming.com)机，两机均为solaris环境，A机在防火墙保护中，B机在防火墙以外，防火墙的管理员控制了访问规则，仅ALLOW 80和53端口的进出数据包。而我们的任务是要利用Httptunnel从A机telnet到B机上，穿过防火墙的限制。操作如下:</p>
<p> 　　首先我们在A上启动client端，命令很简单: client.yiming.com#htc -F 1234 server.yiming.com:80，</p>
<p><span class="amp-wp-36301fc">　　系统回到提示符下，此刻我们用netstat -an 可以看到系统内多出了1234端口的侦听</span></p>
<p> 　　*.1234　　　　　　　　 *.*　　　　　　　　0　　 0　　 0　　 0 LISTEN</p>
<p> 　　然后我们在B机上启动server端，命令如下: server.yiming.com#hts -F localhost:23 80</p>
<p> 　　系统回到提示符下，此刻我们用netstat看</p>
<p> 　　*.80　　　　　　 *.*　　　　　　　　0　　 0　　 0　　 0 LISTEN</p>
<p> 　　80端口处于侦听状态，需要注意的是，如果系统本身跑的有web服务(80端口本身处于侦听)，并不会影响Httptunnel的工作。</p>
<p> 　　Ok,server以及client端都启动了，我们可以开始我们的”通道”试验了，在client.yiming.com上执行一下如下命令看看:</p>
<p> 　　Client.yiming.com#telnet localhost 1234</p>
<p> 　　Trying 0.0.0.0…</p>
<p> 　　Connected to 0.</p>
<p> 　　Escape character is ‘^]’.</p>
<p> 　　SunOS 5.7</p>
<p> 　　This is yiming’s private box! Any question,contact me with yiming@security.zz.ha.cn</p>
<p> 　　login:</p>
<p> 　　看到B机的登录提示符了,输入账号密码看看是否工作正常?</p>
<p> 　　Login:yiming</p>
<p> 　　Password: (omit here;) )</p>
<p> 　　sever.yiming.com# ls</p>
<p> 　　bak　　　　 check　　 go　　　　 httpd　　 lost+found mrtg　　　　run　　　　 soft　　　　wg</p>
<p> 　　OK! 工作正常，和正常的telnet没有什么差别。</p>
<p><span class="amp-wp-36301fc">　仔细观察整个过程，会发现在最开始的地方显示的是Trying 0.0.0.0…，Connected to 0.而不是Trying server.yiming.com…,Connect to server.yiming.com，这就很直观的可以看出来client端是转发1234数据包到本机80端口的。(然后再转发到远端)而不是直接连接远端的B机。</span></p>
<p> 　　上面是比较直观的测试，为了进一步验证server和client之间不是通过23端口通讯，我们抓取数据包来看看。我们在server起个抓包工具tcpdump瞧瞧。</p>
<p><span class="amp-wp-36301fc"> </span></p>
<p><span class="amp-wp-36301fc">　　server.yiming.com#tcpdump host client.yiming.com</span></p>
<p> 　　tcpdump: listening on hme0</p>
<p> 　　14:42:54.213699 client.yiming.com.51767 > server.yiming.com.80: S 1237977857:1237977857(0) win 8760 (DF)</p>
<p> 　　14:42:54.213767server.yiming.com.80 > client.yiming.com.51767: S 1607785698:1607785698(0) ack 1237977858 win 8760 (DF)</p>
<p> 　　14:42:54.216186 client.yiming.com.51768 > server.yiming.com.80: . ack 1 win 8760 (DF)</p>
<p> 　　14:42:54.218661 client.yiming.com.51768 > server.yiming.com.80: P 1:44(43) ack 1 win 8760 (DF)</p>
<p> 　　14:42:54.218728 client.yiming.com.51768 > server.yiming.com.80: P 44:48(4) ack 1 win 8760 (DF)</p>
<p> 　　篇幅所限，上面只是截取了结果中的一点点数据包，但已经可以说明问题了，我们看到server和client之间顺利的完成了三次握手，然后开始push数据，而且通讯确实走的是80端口。有点意思噢。</p>
<p> 　　看是看出来了，但太不直白，到底在搞什么呀，我们再稍微改动一下tcpdump的运行方式，进一步在来看看telnet的数据是否被封装在80端口的数据包内传输?</p>
<p> 　　server.yiming.com#tcpdump -X host client.yiming.com</p>
<p> 　　14:43:05.246911 server.yiming.com.80 > client.yiming.com.51768: . 2997:4457(1460) ack 89 win 8760 (DF)</p>
<p> 　　0x0000 4500 05dc 3b23 4000 ff06 e2c2 yyyy yyyy　　　　E…;#@……f.D</p>
<p> 　　0x0010 xxxx xxxx 0050 de42 5fd5 ac4f 39ac 016f　　　　.f.#.P.B_..O9..o</p>
<p> 　　0x0020 5010 2238 98e4 0000 746f 7461 6c20 3636　　　　P.”8….total.66</p>
<p> 　　0x0030 370d 0a64 7277 7872 2d78 722d 7820 2032　　　　7..drwxr-xr-x..2</p>
<p> 　　0x0040 3920 726f 6f74 2020 2020 2072 6f6f 7420　　　　9.root…..root.</p>
<p> 　　呵呵，这次清楚多了，上面应该是一次ls命令的输出结果，可以清楚的看到telnet的结果!果然telnet的数据是在80端口的数据包内!</p>
<p><span class="amp-wp-36301fc">　　<strong>Httptunnel带来的安全问题</strong></span></p>
<p> 　　写到这里，我们可以想象一下，如果管理员完全信赖防火墙，那么在一个有这样隐患的的局域网中，会发生什么样的后果?</p>
<p> 　　我们可以看到，多年以来，对防火墙的依赖也一直列在SANS的Top 10安全问题中。</p>
<p> 　　既然如此，就很自然的会产生一个问题是:这种httptunnel行为能被发现吗?</p>
<p> 　　首先我们想到的是使用入侵检测系统，在目前的网络安全设计中，防火墙加入侵检测系统是一种比较流行的安全联动配置，既然httptunnel绕过了防火墙，那么IDS系统呢?我们来测测看看。</p>
<p> 　　在下面的测试中，我们将使用IDS系统是Snort，版本1.8.2。这可是大名鼎鼎的开放源代码的IDS系统，在它的说明中，被描述为一个轻量级的，可跨平台工作的入侵检测系统，在2001年12月英国的独立测试实验室NSS的评测中，击败了包括商用IDS系统的所有对手，这些商用软件可是包括 ISS，CISCO SECURE IDS，CA ETRUST，CYBERSAFE CENTRAX，NFR。有兴趣的读者还可以看这篇名为Open source mounts IDS challenge 的报道。</p>
<p> 　　好，对Snort的大致介绍完毕，我们来看看结果吧，Snort对整个试验过程抓获的数据包产成了告警，如下:</p>
<p> 　　[**] WEB-MISC whisker splice attack [**]</p>
<p> 　　12/02-14:42:54.389175 client.yiming.com:51767-> server.yiming.com:80</p>
<p> 　　TCP TTL:251 TOS:0x0 ID:3327 IpLen:20 DgmLen:42 DF</p>
<p> 　　***AP*** Seq: 0x49CA0BA7 Ack: 0x5FD4DCE3 Win: 0x2238 TcpLen: 20</p>
<p> 　　=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+</p>
<p> 　　[**] WEB-MISC whisker splice attack [**]</p>
<p> 　　12/02-14:43:03.195006 client.yiming.com:51767 -> server.yiming.com:80</p>
<p> 　　TCP TTL:251 TOS:0x0 ID:3439 IpLen:20 DgmLen:41 DF</p>
<p> 　　***AP*** Seq: 0x49CA0C20 Ack: 0x5FD4DCE3 Win: 0x2238 TcpLen: 20</p>
<p> 　　=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+</p>
<p> 　　[**] WEB-MISC whisker splice attack [**]</p>
<p> 　　12/02-14:43:04.630268 client.yiming.com:51768-> server.yiming.com:80</p>
<p> 　　TCP TTL:251 TOS:0x0 ID:3496 IpLen:20 DgmLen:41 DF</p>
<p> 　　***AP*** Seq: 0x49CA0C4E Ack: 0x5FD4DCE3 Win: 0x2238 TcpLen: 20</p>
<p> 　　=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+</p>
<p> 　　我们看到snort对抓获的数据包产生了WEB-MISC whisker splice attack的告警，然而这种攻击并没有发生，同时snort对tunnel数据包没有察觉。这样snort就同时出现了IDS系统的两个问题， false positive，false negative。</p>
<p><span class="amp-wp-36301fc">　　这也很正常，因为这也是基于签名的IDS系统的通病，目前决大数 IDS系统包括著名的商用软件ISS,NFR等都是基于签名的，也就是说系统维护着一套特定攻击数据包的数据模式签名。系统工作时，检查经过的数据包的内容，和自己数据库内数据模式签名对比，如果和某种攻击模式签名相同，那么就判断发生了某种攻击。</span></p>
<p> 　　由此我们可以看出很明显的存在若干问题:如对签名的依赖不可避免的导致两个结果，false negative ,false positive。也就是说会产生漏报和误报，这一点很容易理解，当新出现一种攻击模式时，由于IDS系统内没有相应的数据签名，那么就不可能捕获相应的攻击数据包，false negative由此发生。同时，过于依赖签名模式也很容易误报，就象我们上面的例子。同时，对数据签名的依赖会在一定程度上降低系统性能-经过的数据包都需要和IDS系统的签名对照。</p>
<p> 　　此外，基于签名的IDS系统本身有可能由于依据签名这一特性而被攻击，一个例子是stick ，这个程序的作者利用IDS系统进行签名匹配工作原理，发送大量带有攻击特征的数据包给IDS系统，使IDS系统本身处理能力超过极限，从而导致IDS系统无法响应。按照作者Coretez Giovanni的说法，运行2秒钟stick就能使著名的商用IDS系统ISS real secure崩溃。由上我们看到，对IDS系统的完全依赖同样是有风险的。<br> 　<strong>一些解决思路</strong></p>
<p> 　　看来依靠手头的IDS是无法察觉这种行为了，那么有其它办法吗?我们仔细分析一下事件过程中截获的httptunnel数据包再说吧。</p>
<p> 　　仔细观察截获的httptunnel数据包，可以发现紧跟着三次握手完成后的第一个数据包包含着一个POST动作，是由htc(client端)发送到hts(server端)的。如下:</p>
<p> 　　14:55:39.128908 client.yiming.com.51767 > server.yiming.com.80: S 3521931836:3521931836(0) win 8760 (DF)</p>
<p> 　　0x0000 4500 002c d3cc 4000 fb06 53c9 xxxx xxxx　　　　E..,..@…S..f.#</p>
<p> 　　0x0010 yyyy yyyy ca37 0050 d1ec 6a3c 0000 0000　　　　.f.D.7.P..j<….</p>
<p> 　　0x0020 6002 2238 1708 0000 0204 05b4 0000　　　　　　 `.”8……….</p>
<p> 　　14:55:39.128945 server.yiming.com.80 > client.yiming.com.51767: S 2946004964:2946004964(0) ack 3521931837 win 8760 (DF)</p>
<p> 　　0x0000 4500 002c cb85 4000 ff06 5810 yyyy yyyy　　　　E..,..@…X..f.D</p>
<p> 　　0x0010 xxxx xxxx 0050 ca37 af98 77e4 d1ec 6a3d　　　　.f.#.P.7..w…j=</p>
<p> 　　0x0020 6012 2238 ef79 0000 0204 05b4　　　　　　　　 `.”8.y……</p>
<p> 　　14:55:39.131002 client.yiming.com.51767 > server.yiming.com.80: . ack 1 win 8760 (DF)</p>
<p> 　　0x0000 4500 0028 d3cd 4000 fb06 53cc xxxx xxxx　　　　E..(.#</p>
<p> 　　0x0010 yyyy yyyy ca37 0050 d1ec 6a3d af98 77e5　　　　.f.D.7.P..j=..w.</p>
<p> 　　0x0020 5010 2238 0737 0000 0000 0000 0000　　　　　　 P.”8.7……..</p>
<p> 　　14:55:39.132841 server.yiming.com.80 > client.yiming.com.51767: . ack 44 win 8760 (DF)</p>
<p> 　　0x0000 4500 0028 cb86 4000 ff06 5813 yyyy yyyy　　　　E..(　　0x0010 xxxx xxxx 0050 ca37 af98 77e5 d1ec 6a68　　　　.f.#.P.7..w…jh</p>
<p> 　　0x0020 5010 2238 070c 0000　　　　　　　　　　　　　　P.”8….</p>
<p> 　　14:55:39.132860 client.yiming.com.51767 > server.yiming.com.80: P 1:44(43) ack 1 win 8760 (DF)</p>
<p> 　　0x0000 4500 0053 d3ce 4000 fb06 53a0 xxxx xxxx</p>
<p> 　　0x0010 yyyy yyyy ca37 0050 d1ec 6a3d af98 77e5　　　　.f.D.7.P..j=..w.</p>
<p> 　　0x0020 5018 2238 d23a 0000 504f 5354 202f 696e　　　　P.”8.:..POST/in</p>
<p> 　　0x0030 6465 782e 6874 6d6c 3f63 7261 703d 3130　　　　dex.html?crap=10</p>
<p> 　　0x0040 3037 3838 3034 3836 2048 5454 502f 312e　　　　07880486.HTTP/1.</p>
<p> 　　0x0050 310d 0a　　　　　　　　　　　　　　　　　　　　1..</p>
<p> 　　1..</p>
<p><span class="amp-wp-36301fc"> </span></p>
<p><span class="amp-wp-36301fc">　　看起来是发送client端的数据包到server端的，那么server有什么反应呢?我们往下看,在上面这个过程完成后，htc和hts又发生了一次握手(注意，又一次握手)，如下:</span></p>
<p> 　　14:55:39.134301 client.yiming.com.51768 > server.yiming.com.80: S 2851199448:2851199448(0) win 8760 (DF)</p>
<p> 　　0x0000 4500 002c d3df 4000 fb06 53b6 xxxx xxxx　　　　E..,..@…S..f.#</p>
<p> 　　0x0010 yyyy yyyy ca38 0050 a9f1 d9d8 0000 0000　　　　.f.D.8.P……..</p>
<p> 　　0x0020 6002 2238 cf65 0000 0204 05b4 0000　　　　　　 `.”8.e……..</p>
<p> 　　14:55:39.134389 server.yiming.com.80 > client.yiming.com.51768: S 2946060449:2946060449(0) ack 2851199449 win 8760 (DF)</p>
<p> 　　0x0000 4500 002c cb8f 4000 ff06 5806 yyyy yyyy　　　　E..,..@…X..f.D</p>
<p> 　　0x0010 xxxx xxxx 0050 ca38 af99 50a1 a9f1 d9d9　　　　.f.#.P.8..P…..</p>
<p> 　　0x0020 6012 2238 cf19 0000 0204 05b4　　　　　　　　 `.”8……..</p>
<p> 　　14:55:39.136527 client.yiming.com.51768 > server.yiming.com.80: . ack 1 win 8760 (DF)</p>
<p> 　　0x0000 4500 0028 d3e0 4000 fb06 53b9 xxxx xxxx　　　　E..(</p>
<p> 　　0x0010 yyyy yyyy ca38 0050 a9f1 d9d9 af99 50a2　　　　.f.D.8.P……P.</p>
<p> 　　0x0020 5010 2238 e6d6 0000 0000 0000 0000　　　　　　 P.”8……….</p>
<p> 　　14:55:39.137333 client.yiming.com.51768 > server.yiming.com.80: P 1:43(42) ack 1 win 8760 (DF)</p>
<p> 　　0x0000 4500 0052 d3e1 4000 fb06 538e xxxx xxxx</p>
<p> 　　0x0010 yyyy yyyy ca38 0050 a9f1 d9d9 af99 50a2　　　　.f.D.8.P……P.</p>
<p> 　　0x0020 5018 2238 25ce 0000 4745 5420 2f69 6e64　　　　P.”8%…GET/ind</p>
<p> 　　0x0030 6578 2e68 746d 6c3f 6372 6170 3d31 3030　　　　ex.html?crap=100</p>
<p> 　　0x0040 3738 3830 3438 3620 4854 5450 2f31 2e31　　　　7880486.HTTP/1.1</p>
<p> 　　0x0050 0d0a　　　　　　　　　　　　　　　　　　　　 ..</p>
<p> 　　14:55:39.137379 server.yiming.com.80 > client.yiming.com.51768: . ack 43 win 8718 (DF)</p>
<p> 　　0x0000 4500 0028 cb90 4000 ff06 5809 yyyy yyyy　　　　E..(</p>
<p> 　　0x0010 xxxx xxxx 0050 ca38 af99 50a2 a9f1 da03　　　　.f.#.P.8..P…..</p>
<p> 　　0x0020 5010 220e e6d6 0000　　　　　　　　　　　　　　P.”…..</p>
<p> 　　14:55:39.139733 client.yiming.com.51768 > server.yiming.com.80: P 43:89(46) ack 1 win 8760 (DF)</p>
<p> 　　0x0000 4500 0056 d3e2 4000 fb06 5389 xxxx xxxx　　　　.#</p>
<p> 　　0x0010 yyyy yyyy ca38 0050 a9f1 da03 af99 50a2　　　　.f.D.8.P……P.</p>
<p> 　　0x0020 5018 2238 e156 0000 486f 7374 3a20 3230　　　　P.”8.V..Host:.20</p>
<p> 　　0x0030 322e 3130 322e 3232 372e 3638 3a38 300d　　　　2.102.227.68:80.</p>
<p> 　　0x0040 0a43 6f6e 6e65 6374 696f 6e3a 2063 6c6f　　　　.Connection:.clo</p>
<p> 　　0x0050 7365 0d0a 0d0a　　　　　　　　　　　　　　　　 se….</p>
<p> 　　14:55:39.151300 server.yiming.com.80 > client.yiming.com.51768: P 1:170(169) ack 89 win 8760 (DF)</p>
<p> 　　0x0000 4500 00d1 cb91 4000 ff06 575f yyyy yyyy</p>
<p> 　　0x0010 xxxx xxxx 0050 ca38 af99 50a2 a9f1 da31　　　　.f.#.P.8..P….1</p>
<p> 　　0x0020 5018 2238 e721 0000 4854 5450 2f31 2e31　　　　P.”8.!..HTTP/1.1</p>
<p> 　　0x0030 2032 3030 204f 4b0d 0a43 6f6e 7465 6e74　　　　.200.OK..Content</p>
<p> 　　0x0040 2d4c 656e 6774 683a 2031 3032 3430 300d　　　　-Length:.102400.</p>
<p> 　　0x0050 0a43 6f6e 6e65 6374 696f 6e3a 2063 6c6f　　　　.Connection:.clo</p>
<p> 　　0x0060 7365 0d0a 5072 6167 6d61 3a20 6e6f 2d63　　　　se..Pragma:.no-c</p>
<p> 　　0x0070 6163 6865 0d0a 4361 6368 652d 436f 6e74　　　　ache..Cache-Cont</p>
<p> 　　0x0080 726f 6c3a 206e 6f2d 6361 6368 652c 206e　　　　rol:.no-cache,.n</p>
<p> 　　0x0090 6f2d 7374 6f72 652c 206d 7573 742d 7265　　　　o-store,.must-re</p>
<p> 　　0x00a0 7661 6c69 6461 7465 0d0a 4578 7069 7265　　　　validate..Expire</p>
<p> 　　0x00b0 733a 2030 0d0a 436f 6e74 656e 742d 5479　　　　s:.0..Content-Ty</p>
<p> 　　0x00c0 7065 3a20 7465 7874 2f68 746d 6c0d 0a0d　　　　pe:.text/html…<br> 从数据包中可以看到，本次通讯中 hts(server)端向htc(client)端发送了一个GET的标识包，估计是去”取”刚才client端发来的数据包，而且是一次新的握手!为了验证，我们分别在client,server端，执行netstat -an，结果证明了我们的观察是正确的，如下:</p>
<p><span class="amp-wp-36301fc"> </span></p>
<p><span class="amp-wp-36301fc">　　client.yiming.com.51767　　　　server.yiming.com.80　　 8760　　 0 8760　　 0 ESTABLISHED</span></p>
<p> 　　client.yiming.com.51768　　　　server.yiming.com.80　　 8760　　 0 8760　　 0 ESTABLISHED</p>
<p> 　　在server端，执行netstat -an，结果如下:</p>
<p> 　　server.yiming.com.80　　client.yiming.com.51767 8760　　 0 8760　　 0 ESTABLISHED</p>
<p> 　　server.yiming.com.80　　client.yiming.com.51768 8760　　 0 8760　　 0 ESTABLISHED</p>
<p> 　　果然，防火墙两边的系统都起了两个socket，和一般程序不同，这是个比较特殊的现象。</p>
<p> 　　GET动作完成后，server端又向client端发送了一个数据包，内容是</p>
<p> 　　HTTP/1.1 200 OK Content-Length: 102400</p>
<p> 　　Connection: close</p>
<p> 　　Pragma: no-cache</p>
<p> 　　Cache-Control: no-cache, no-store, must-revalidate</p>
<p> 　　Expires: 0</p>
<p> 　　Content-Type: text/html</p>
<p> 　　这里应该是定义数据包传输最大值等参数的。</p>
<p> 　　作者察觉，经由了这三次htc和hts之间的作用后，httptunnel才真正的建立起来，后面的工作才能正常开展，而且很有意思的是，自此以后所有后续的数据包一律没有80端口经常走的GET,PUT,POST之类的内容!!这里看来可以想点办法。</p>
<p><span class="amp-wp-36301fc">　　上面说过，正常走80端口的数据包应该是web行为，那么就数据包中就应该少不了get等正常的动作内容，如果在80端口经过的数据总是没有这些东东，那么就肯定有问题了，</span></p>
<p> 　　那么这种问题就有了一种解决方案，就是手工检查通过80端口通过的数据包，如果数据包是明文传送，那么就很容易发现这种行为。但这种行为也只能在理论上可行。在实际上的操作是不可能的，有没有比较成熟的这种产品呢?按照这个思路检索网上的数据，果然发现有种入侵检测e-Gap系统可以确实察觉及屏蔽 httptunnel等通道软件的存在，它工作在tcp/ip的应用层，在应用层一级检测数据包的确切性，比如，检测80端口的数据包，如果看起来数据包中总是没有有效的数据(URL,get,put等参数)，那么e-Gap系统就会报警，并中断连接行为。</p>
<p> 　　需要注意的是，这种侦测方法仅对明文传送的有效，如果数据被加密，那么也就无计可施了。那么再进一步，如果加密了呢?目前作者掌握的情况来看， StealthWatch硬件产品可能是一种比较好的选择，它完全摈弃了基于签名的工作模式，而是采用一种正在申请专利的基于flow-base构架策略，按照几家评测实验室的结果来看，可以有效的察觉已经公开和未公开的各种攻击，Dos，蠕虫，病毒等，甚至包括加密的通讯!但是，它的价钱也远远的超出了普通的商用IDS系统，一套齐备的设施需4万美元!具体效果作者目前没有条件测试。</p>
<p> 　　<strong>总结</strong></p>
<p> 　　在我们的试验中，httptunnel同时逃过了防火墙的屏蔽以及入侵检测系统的追踪，这是值得思考的。我们可以看到，网络安全仅仅依靠某种或某几种手段是不可靠的，尤其是对安全性要求很高的应用系统，同时对安全系统的盲目依赖往往会造成巨大的安全隐患</p>
</div>
<div class="more-toolbox">
<div class="left-toolbox">
<ul class="toolbox-list">
<li class="tool-item tool-active is-like "><a><br>
      <svg class="icon" aria-hidden="true"><br>
       <use xlink:href="#csdnc-thumbsup"></use><br>
      </svg><span class="name">点赞</span> <span class="count"></span> </a></li>
<li class="tool-item tool-active is-collection "><a data-report-click='{"mod":"popu_824"}'><br>
      <svg class="icon" aria-hidden="true"><br>
       <use xlink:href="#icon-csdnc-Collection-G"></use><br>
      </svg><span class="name">收藏</span></a></li>
<li class="tool-item tool-active is-share"><a data-report-click='{"mod":"1582594662_002"}'><br>
      <svg class="icon" aria-hidden="true"><br>
       <use xlink:href="#icon-csdnc-fenxiang"></use><br>
      </svg>分享</a></li>
<p>    <br>
     </p>
<li class="tool-item tool-more"> <a><br>
      <svg class="icon" viewbox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><br>
       <defs>

<p>       </p></defs>
       <path d="M179.176 499.222m-113.245 0a113.245 113.245 0 1 0 226.49 0 113.245 113.245 0 1 0-226.49 0Z"></path>
       <path d="M509.684 499.222m-113.245 0a113.245 113.245 0 1 0 226.49 0 113.245 113.245 0 1 0-226.49 0Z"></path>
       <path d="M846.175 499.222m-113.245 0a113.245 113.245 0 1 0 226.49 0 113.245 113.245 0 1 0-226.49 0Z"></path>
      </svg> </a> 
<ul class="more-box">
<li class="item"><a class="article-report">文章举报</a></li>
</ul>
</li>
</ul></div>
</div>
<div class="person-messagebox">
<div class="left-message">
   <a href="https://blog.csdn.net/gx11251143"> <amp-img src="https://profile.csdnimg.cn/2/5/D/3_gx11251143" class="avatar_pic amp-wp-enforced-sizes" width="75" height="75" layout="intrinsic"><noscript><img src="https://profile.csdnimg.cn/2/5/D/3_gx11251143" class="avatar_pic" width="75" height="75"></noscript></amp-img> <amp-img src="https://g.csdnimg.cn/static/user-reg-year/1x/8.png" class="user-years amp-wp-enforced-sizes" width="22" height="23" layout="intrinsic"><noscript><img src="https://g.csdnimg.cn/static/user-reg-year/1x/8.png" class="user-years" width="22" height="23"></noscript></amp-img> </a>
  </div>
<div class="middle-message">
<div class="title">
    <span class="tit"><a href="https://blog.csdn.net/gx11251143" data-report-click='{"mod":"popu_379"}' target="_blank" rel="noopener noreferrer">时间催熟</a></span>
   </div>
<div class="text">
    <span>发布了5 篇原创文章</span> ·<br>
    <span>获赞 3</span> ·<br>
    <span>访问量 3060</span>
   </div>
</div>
<div class="right-message">
   <a href="https://im.csdn.net/im/main.html?userName=gx11251143" target="_blank" class="btn btn-sm btn-red-hollow bt-button personal-letter" rel="noopener noreferrer">私信 </a><br>
   <a class="btn btn-sm  bt-button personal-watch" data-report-click='{"mod":"popu_379"}'>关注</a>
  </div>
</div>
</div>
	</div>

	<footer class="amp-wp-article-footer">
			<div class="amp-wp-meta amp-wp-tax-category">
		Categories: Uncategorized	</div>

	</footer>
</article>

<footer class="amp-wp-footer">
	<div>
		<h2>有组织在!</h2>
		<a href="#top" class="back-to-top">Back to top</a>
	</div>
</footer>



</body>
</html>
